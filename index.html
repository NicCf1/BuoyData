<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Buoy Measurements Graph</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
  #controls { margin-bottom: 20px; }
  select { padding: 5px; margin: 0 10px; font-size: 1em; }
</style>
</head>
<body>

<h2>Buoy Measurements</h2>

<div id="controls">
  <label>Measurement: 
    <select id="measurementSelect">
      <option value="water" selected>Water Temp (°F)</option>
      <option value="seabed">Seabed Temp (°F)</option>
      <option value="air">Air Temp (°F)</option>
      <option value="baro">Barometric (inHg)</option>
      <option value="light">Light %</option>
    </select>
  </label>

  <label>Number of readings: 
    <select id="numSelect">
      <option value="12">Last 12</option>
      <option value="24">Last 24</option>
      <option value="50">Last 50</option>
      <option value="all">All</option>
    </select>
  </label>
</div>

<canvas id="myChart" width="900" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0/dist/chartjs-adapter-luxon.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdJEMFFaONhtyaDh6C1hn42VSftOUH8bUMQN3RD-L4WXu46mntzuqkGgqKWBK0BbiZ58kdTuSnTDac/pub?output=csv";

let allData = [];
let chart;

// Fetch CSV
fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n").map(r => r.split(","));
    const dataRows = rows.slice(1); // skip header
    allData = dataRows.map(r => ({
      water: parseFloat(r[2]),
      seabed: parseFloat(r[3]),
      air: parseFloat(r[4]),
      baro: parseFloat(r[5]),
      light: parseFloat(r[6]),
      datetime: r[10] // Use column K
    })).filter(d => !isNaN(d.water));

    drawChart('water', 12); // default
  })
  .catch(e=>console.error("CSV fetch error", e));

// Draw chart
function drawChart(measurement, num){
  const dataSubset = (num==='all') ? allData : allData.slice(-num);
  const labels = dataSubset.map(d => new Date(d.datetime));

  const colorMap = {water:'blue', seabed:'purple', air:'red', baro:'green', light:'orange'};
  const minMaxMap = {
    water:[0,100],
    seabed:[0,100],
    air:[0,100],
    baro:[28,31],
    light:[0,100]
  };

  const datasets = [{
    label: measurement,
    data: dataSubset.map(d => d[measurement]),
    borderColor: colorMap[measurement],
    backgroundColor: colorMap[measurement],
    fill:false,
    pointRadius:4
  }];

  const options = {
    responsive:true,
    plugins:{
      legend:{position:'top'},
      tooltip:{
        callbacks:{
          label: function(ctx){
            let value = ctx.parsed.y;
            const datetime = ctx.label;
            if(ctx.dataset.label==='baro') value = value.toFixed(2) + ' inHg';
            else if(ctx.dataset.label==='light') value = value + ' %';
            else value = value + ' °F';
            return `${value} at ${datetime}`;
          }
        }
      }
    },
    scales:{
      x:{
        type:'time',
        time:{
          parser:'MMM dd h:mm a', // matches "Feb 16 7:45 AM"
          tooltipFormat:'MMM dd h:mm a',
          unit:'hour',
          displayFormats:{
            hour:'MMM dd h:mm a',
            day:'MMM dd'
          }
        },
        title:{
          display:true,
          text:'Date & Time',
          font:{size:14, weight:'bold'}
        },
        ticks:{
          autoSkip:true,
          maxRotation:45,
          minRotation:30
        }
      },
      y:{
        type:'linear',
        min:minMaxMap[measurement][0],
        max:minMaxMap[measurement][1],
        title:{
          display:true,
          text: measurement==='water'||measurement==='seabed'||measurement==='air' ? 'Temperature (°F)' :
               measurement==='baro' ? 'Barometric Pressure (inHg)' : 'Light %',
          color: colorMap[measurement],
          font:{size:16, weight:'bold'}
        }
      }
    }
  };

  if(chart) chart.destroy();
  const ctx = document.getElementById('myChart').getContext('2d');
  chart = new Chart(ctx,{type:'line', data:{labels,datasets}, options});
}

// Dropdown events
document.getElementById('measurementSelect').addEventListener('change', e=>{
  const num = document.getElementById('numSelect').value;
  drawChart(e.target.value, num);
});
document.getElementById('numSelect').addEventListener('change', e=>{
  const measurement = document.getElementById('measurementSelect').value;
  drawChart(measurement, e.target.value);
});
</script>

</body>
</html>

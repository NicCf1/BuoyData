const datasets = [{
  label: measurement,
  data: dataSubset.map(d=>{
    if(measurement==='baro'){
      // Convert hPa to inHg (if your sheet is in hPa), or assume already in inHg
      // Then map to 0-100 for display purposes
      const inHg = d.baro; // if your sheet already uses inHg
      const minInHg = 28;  // approximate min expected inHg
      const maxInHg = 31;  // approximate max expected inHg
      // Map to 0-100 scale
      return ((inHg - minInHg)/(maxInHg - minInHg))*100;
    } else {
      return d[measurement];
    }
  }),
  borderColor: colorMap[measurement],
  backgroundColor: colorMap[measurement],
  fill:false,
  pointRadius:4
}];

const minMaxMap = {
  water:[0,100],
  seabed:[0,100],
  air:[0,100],
  baro:[0,100],  // now baro is mapped to 0-100
  light:[0,100]
};

const options = {
  responsive:true,
  plugins:{
    legend:{position:'top'},
    tooltip:{
      callbacks:{
        label: function(context){
          let value = context.parsed.y;
          const datetime = context.label;
          if(context.dataset.label==='baro'){
            // Convert back to inHg for tooltip
            const minInHg = 28;
            const maxInHg = 31;
            value = (value/100)*(maxInHg - minInHg) + minInHg;
            value = value.toFixed(2) + ' inHg';
          } else if(context.dataset.label==='light'){
            value = value + ' %';
          } else {
            value = value + ' °F';
          }
          return `${value} at ${datetime}`;
        }
      }
    }
  },
  scales:{
    y:{
      type:'linear',
      min:minMaxMap[measurement][0],
      max:minMaxMap[measurement][1],
      title:{
        display:true,
        text:measurement==='water'||measurement==='seabed'||measurement==='air' ? 'Temperature (°F)' :
             measurement==='baro' ? 'Barometric (inHg scaled 0-100)' : 'Light %',
        color: colorMap[measurement],
        font: {size:16, weight:'bold'}
      }
    }
  }
};
